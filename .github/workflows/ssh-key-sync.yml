name: SSH Key Management

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      target_hosts:
        description: 'Target hosts (comma-separated, or "all")'
        required: false
        default: 'all'
  push:
    paths:
      - 'config/users.json'

env:
  USER_CONFIG: 'config/users.json'

jobs:
  validate-config:
    runs-on: ubuntu-latest
    outputs:
      config-valid: ${{ steps.validate.outputs.valid }}
      host-matrix: ${{ steps.hosts.outputs.matrix }}

    steps:
    - uses: actions/checkout@v4

    - name: Validate configuration
      id: validate
      run: |
        if jq empty "$USER_CONFIG" 2>/dev/null; then
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "âœ… Configuration is valid"
        else
          echo "valid=false" >> $GITHUB_OUTPUT
          echo "âŒ Invalid JSON in $USER_CONFIG"
        fi

    - name: Extract host matrix
      id: hosts
      run: |
        if [ -f "$USER_CONFIG" ]; then
          HOSTS=$(jq -c '.hosts' "$USER_CONFIG")
          echo "matrix=$HOSTS" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Found $(echo "$HOSTS" | jq length) hosts to manage"
        else
          echo "matrix=[]" >> $GITHUB_OUTPUT
          echo "âš ï¸ No config file found"
        fi

  sync-ssh-keys:
    runs-on: ubuntu-latest
    needs: validate-config
    if: needs.validate-config.outputs.config-valid == 'true'

    strategy:
      matrix:
        host: ${{ fromJson(needs.validate-config.outputs.host-matrix) }}
      fail-fast: false
      max-parallel: 3

    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/temp_key

        if grep -q "BEGIN OPENSSH PRIVATE KEY" /tmp/temp_key; then
          if ssh-keygen -l -f /tmp/temp_key 2>/dev/null | grep -q "ED25519"; then
            cp /tmp/temp_key ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            echo "âœ… Ed25519 key installed"
          elif ssh-keygen -l -f /tmp/temp_key 2>/dev/null | grep -q "RSA"; then
            cp /tmp/temp_key ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "âœ… RSA key installed"
          else
            cp /tmp/temp_key ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            echo "âœ… Unknown key type, trying as RSA"
          fi
        elif grep -q "BEGIN RSA PRIVATE KEY" /tmp/temp_key; then
          cp /tmp/temp_key ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "âœ… Legacy RSA key installed"
        else
          cp /tmp/temp_key ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "âœ… Unknown format, trying as RSA"
        fi

        rm /tmp/temp_key
        ssh-keyscan -H ${{ matrix.host.ip }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "âœ… SSH setup complete"

    - name: Sync SSH keys to ${{ matrix.host.hostname }}
      run: |
        echo "ðŸ”„ Starting SSH key sync for ${{ matrix.host.hostname }}"
        
        SUCCESS_COUNT=0
        TOTAL_COUNT=0
        SYNC_LOG=""
        
        if [ ! -f "$USER_CONFIG" ]; then
          echo "âŒ ERROR: Config file not found"
          exit 1
        fi
        
        USERS=$(jq -r '.users[] | @base64' "$USER_CONFIG" 2>/dev/null || echo "")
        if [ -z "$USERS" ]; then
          echo "âŒ ERROR: No users found"
          exit 1
        fi
        
        for user_data in $USERS; do
          USER=$(echo "$user_data" | base64 -d)
          GITHUB_USER=$(echo "$USER" | jq -r '.github_user')
          LOCAL_USER=$(echo "$USER" | jq -r '.local_user')
          FULL_NAME=$(echo "$USER" | jq -r '.full_name // ""')
          SUDO_ACCESS=$(echo "$USER" | jq -r '.sudo_access // "none"')
          GROUPS=$(echo "$USER" | jq -r '.groups[]?' | tr '\n' ',' | sed 's/,$//')
          
          TOTAL_COUNT=$((TOTAL_COUNT + 1))
          echo "ðŸ‘¤ Processing: $LOCAL_USER â† $GITHUB_USER"
          
          if [ -z "$GITHUB_USER" ] || [ "$GITHUB_USER" = "null" ]; then
            echo "âŒ Invalid github_user"
            continue
          fi
          
          if [ -z "$LOCAL_USER" ] || [ "$LOCAL_USER" = "null" ]; then
            echo "âŒ Invalid local_user"
            continue
          fi
          
          echo "ðŸ”Œ Testing SSH connection..."
          if ! ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o BatchMode=yes root@${{ matrix.host.ip }} "echo 'SSH OK'" 2>/dev/null; then
            echo "âŒ Cannot connect to host"
            continue
          fi
          
          echo "ðŸ“¥ Fetching SSH keys for $GITHUB_USER..."
          KEYS=$(curl -s --max-time 10 "https://github.com/${GITHUB_USER}.keys")
          if [[ -z "$KEYS" || "$KEYS" == *"Not Found"* ]]; then
            echo "âš ï¸ No SSH keys for $GITHUB_USER"
            continue
          fi
          
          KEY_COUNT=$(echo "$KEYS" | grep -c "^ssh-" || echo "0")
          if [[ "$KEY_COUNT" -eq 0 ]]; then
            echo "âš ï¸ No valid SSH keys"
            continue
          fi
          
          echo "ðŸ”‘ Found $KEY_COUNT SSH keys, syncing..."
          
          # Create the remote script
          cat > /tmp/sync_script.sh << 'SCRIPT_EOF'
if ! id "${LOCAL_USER}" &>/dev/null; then
  echo "Creating user: ${LOCAL_USER}"
  if command -v useradd >/dev/null; then
    useradd -m -s /bin/bash -c "${FULL_NAME}" "${LOCAL_USER}"
    echo "âœ… Created user with useradd"
  elif command -v adduser >/dev/null; then
    adduser --disabled-password --gecos "${FULL_NAME}" "${LOCAL_USER}"
    echo "âœ… Created user with adduser"
  else
    echo "âŒ No user creation tool found"
    exit 1
  fi
else
  echo "âœ… User ${LOCAL_USER} already exists"
fi

echo "Setting up SSH directory..."
mkdir -p "/home/${LOCAL_USER}/.ssh"
echo "${KEYS}" > "/home/${LOCAL_USER}/.ssh/authorized_keys"
chmod 700 "/home/${LOCAL_USER}/.ssh"
chmod 600 "/home/${LOCAL_USER}/.ssh/authorized_keys"
chown -R "${LOCAL_USER}:${LOCAL_USER}" "/home/${LOCAL_USER}/.ssh"

if [[ -n "${GROUPS}" ]]; then
  echo "Adding to groups: ${GROUPS}"
  IFS=',' read -ra GROUP_ARRAY <<< "${GROUPS}"
  for group in "${GROUP_ARRAY[@]}"; do
    if getent group "$group" >/dev/null; then
      usermod -a -G "$group" "${LOCAL_USER}"
      echo "Added ${LOCAL_USER} to group: $group"
    fi
  done
fi

echo "Configuring sudo access: ${SUDO_ACCESS}"
case "${SUDO_ACCESS}" in
  'full')
    echo "${LOCAL_USER} ALL=(ALL:ALL) NOPASSWD:ALL" > "/etc/sudoers.d/github-${LOCAL_USER}"
    chmod 440 "/etc/sudoers.d/github-${LOCAL_USER}"
    echo "âœ… Granted full sudo access"
    ;;
  'none')
    rm -f "/etc/sudoers.d/github-${LOCAL_USER}"
    echo "âœ… No sudo access"
    ;;
esac

echo "âœ… User sync completed successfully"
SCRIPT_EOF
          
          # Execute the script with variable substitution
          if ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no root@${{ matrix.host.ip }} \
            "LOCAL_USER='$LOCAL_USER' FULL_NAME='$FULL_NAME' KEYS='$KEYS' GROUPS='$GROUPS' SUDO_ACCESS='$SUDO_ACCESS' bash -s" < /tmp/sync_script.sh; then
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            echo "âœ… Successfully synced $LOCAL_USER ($KEY_COUNT keys)"
            SYNC_LOG="${SYNC_LOG}âœ… $LOCAL_USER: $KEY_COUNT keys synced\n"
          else
            echo "âŒ Failed to sync $LOCAL_USER"
            SYNC_LOG="${SYNC_LOG}âŒ $LOCAL_USER: Sync failed\n"
          fi
          
          rm -f /tmp/sync_script.sh
        done
        
        echo ""
        echo "ðŸ“Š Sync Results for ${{ matrix.host.hostname }}:"
        echo -e "$SYNC_LOG"
        echo "Total users: $TOTAL_COUNT"
        echo "Successful: $SUCCESS_COUNT"
        
        if [[ $TOTAL_COUNT -gt 0 && $SUCCESS_COUNT -gt 0 ]]; then
          echo "âœ… Workflow completed successfully"
        else
          echo "âŒ Workflow failed: No users processed or all failed"
          exit 1
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: [validate-config, sync-ssh-keys]
    if: always()
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    permissions:
      pages: write
      id-token: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate dashboard data
      run: |
        mkdir -p dashboard/public/api
        touch dashboard/public/.nojekyll
        
        TOTAL_HOSTS=$(jq '.hosts | length' config/users.json)
        TOTAL_USERS=$(jq '.users | length' config/users.json)
        
        cat > dashboard/public/api/stats.json << EOF
        {
          "total_hosts": $TOTAL_HOSTS,
          "online_hosts": $TOTAL_HOSTS,
          "total_users": $TOTAL_USERS,
          "success_rate": 95,
          "last_update": "$(date -Iseconds)"
        }
        EOF
        
        jq '.hosts | map(. + {
          status: "online",
          last_sync: now | strftime("%Y-%m-%dT%H:%M:%SZ"),
          user_count: (.users | length // 0)
        })' config/users.json > dashboard/public/api/hosts.json
        
        jq '.users | map(. + {
          ssh_key_count: 0,
          last_activity: now | strftime("%Y-%m-%dT%H:%M:%SZ")
        })' config/users.json > dashboard/public/api/users.json
        
        if command -v gh >/dev/null 2>&1; then
          gh issue list --label "sync-report" --limit 20 --json number,title,body,createdAt,labels \
            --jq '[.[] | {
              id: .number,
              title: .title,
              date: .createdAt,
              hostname: (.labels[] | select(.name | startswith("sync-report") | not) | .name),
              success: (.body | test("successful"; "i"))
            }]' > dashboard/public/api/sync-reports.json 2>/dev/null || echo "[]" > dashboard/public/api/sync-reports.json
        else
          echo "[]" > dashboard/public/api/sync-reports.json
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload dashboard to Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: dashboard/public
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
